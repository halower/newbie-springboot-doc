# 乐观锁
?> 后期可能涉及到分布式系统时，我们通常把多个微服务部署在内网集群中，再用API网关聚合起来对外提供。为了做负载均衡，通常会对每个微服务都启动多个运行实例，通过注册中心去调用。虽然微服务网关会把每一个请求只转发给一个实例，但当面对高并发时，但它们仍然可能同时操作同一个数据库表。我们可以使用JPA提供的乐观锁去解决问题，但是如果频率再高一点就需要考虑到使用利用`Redis`,`Zookeeper` 实现 `分布式锁`了。这里我们介绍下`JPA乐观锁`的使用

!> 如果使用数据库自带的锁机制，在写入的时候锁定数据库，其他修改请求到来时就必须等待锁释放，但这就使效率降下来了，而且高并发场景下可能有的请求一直抢不到锁，就会长时间卡在那导致请求失败，然后有大量重试，系统可能会发生连接数耗尽等异常。

## 乐观锁的使用
> 它是为数据库表增加一个标识数据版本的version字段来实现的，读取数据时把version字段一同读出，写入数据库时比对version字段就知道数据是否被更改过，如果version不相等就说明持有的是过期数据，不能写入，如果相等就可以写入，并把`version` + 1

![](_img/lgs.jpg)

> 给数据库表添加乐观锁很简单，添加一个整型字段，并加入@Version注解就可以了，每次提交数据时会自动检查版本

```
    @Entity  
    public class Blog {  
    ...  
        @Version  
        private int version;  
    ...  
    }  
```